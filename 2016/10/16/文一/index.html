<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>KVO实现MVVM | 燕航的博客，感谢访问哈！</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="为什么要用MVVM代替MVC？Apple倡导开发者们使用MVC模式开发App程序，但很多人都没有严格按照MVC的模式去开发，只是让程序的架构看上去像MVC，而实际上是MC或VC">
<meta property="og:type" content="article">
<meta property="og:title" content="KVO实现MVVM">
<meta property="og:url" content="http://yoursite.com/2016/10/16/文一/index.html">
<meta property="og:site_name" content="燕航的博客，感谢访问哈！">
<meta property="og:description" content="为什么要用MVVM代替MVC？Apple倡导开发者们使用MVC模式开发App程序，但很多人都没有严格按照MVC的模式去开发，只是让程序的架构看上去像MVC，而实际上是MC或VC">
<meta property="og:image" content="http://of6e0nb1h.bkt.clouddn.com/259158-73951dca6dd10e38.png">
<meta property="og:image" content="http://of6e0nb1h.bkt.clouddn.com/259158-9b8c5b88df49ff3d.png">
<meta property="og:updated_time" content="2016-10-19T17:47:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="KVO实现MVVM">
<meta name="twitter:description" content="为什么要用MVVM代替MVC？Apple倡导开发者们使用MVC模式开发App程序，但很多人都没有严格按照MVC的模式去开发，只是让程序的架构看上去像MVC，而实际上是MC或VC">
<meta name="twitter:image" content="http://of6e0nb1h.bkt.clouddn.com/259158-73951dca6dd10e38.png">
  
    <link rel="alternative" href="/atom.xml" title="燕航的博客，感谢访问哈！" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <script src="/style.js"></script>
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/images/avatar.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">燕 航</a></h1>
		</hgroup>

		
		<p class="header-subtitle">个人站</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/随笔">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">标签</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="3" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/dahangda" title="github">github</a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/wlyanhang" title="weibo">weibo</a>
		        
					<a class="mail" target="_blank" href="/yanhang291@gmail.com" title="mail">mail</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">燕 航</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="/images/avatar.png" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">燕 航</h1>
			</hgroup>
			
			<p class="header-subtitle">个人站</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/tags/随笔">随笔</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/dahangda" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/wlyanhang" title="weibo">weibo</a>
			        
						<a class="mail" target="_blank" href="/yanhang291@gmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        <article id="post-文一" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      KVO实现MVVM
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="为什么要用MVVM代替MVC？"><a href="#为什么要用MVVM代替MVC？" class="headerlink" title="为什么要用MVVM代替MVC？"></a>为什么要用MVVM代替MVC？</h2><p>Apple倡导开发者们使用MVC模式开发App程序，但很多人都没有严格按照MVC的模式去开发，只是让程序的架构看上去像MVC，而实际上是MC或VC<br><a id="more"></a><br>很多入门开发者都有一个通病，就是把所有的逻辑，界面生成都写进ViewController中，这样ViewController就变成了一个Massive View Controller（重量级视图控制器）。重量级视图控制器会让整个ViewController变得非常复杂且不可维护，让维护者崩溃却无从下手，只能忍痛默默的重写整个逻辑。<br>但是，有一种解决方案，可以解决Massive View Controller的问题，那就是MVVM。<br>这是传统MVC模式：</p>
<p><img src="http://of6e0nb1h.bkt.clouddn.com/259158-73951dca6dd10e38.png" alt="图片"></p>
<p>这是MVVM模式<br><img src="http://of6e0nb1h.bkt.clouddn.com/259158-9b8c5b88df49ff3d.png" alt=""><br>很多时候新手们会把数据转换逻辑，网络请求逻辑等都放到ViewController中，这样会不可避免的让ViewController变得臃肿，这是造成重量级视图控制器的重要原因<br>除了上面提到的一个原因外，由于AFNetworking是iOS开发网络访问框架的事实标准，而AFNetworking使用的是block来实现网络回调，block会让block里面引用的变量的引用数+1，在某种网速非常缓慢的极端情况下，当用户打开ViewController的时候，网络请求已经发出，也就是说在block中的变量引用已经+1，如果此时用户退出这个ViewController，当这个block发生回调时，此时持有block里面变量的ViewController已经被回收，而block里面的变量由于block的原因没有被及时回收，这样会造成crash的。这是在使用block进行回调时很容易被忽略的情况。<br>对于业务而言，将所有业务不加区分都放进ViewController中，这显然是一种懒惰的表现。一个ViewController中包含大量业务的细节，将使这个ViewController在业务协调和调用中迷失，将让这个业务变得非常混乱，让业务逻辑变得无法维护。由于重量级ViewController的复杂性，其代码将难以复用。</p>
<p>以上原因是传统MVC难以解决的，为解决这些问题，要采用MVVM的开发模式。</p>
<p>MVVM不是什么新鲜事，简单说就是将部分逻辑从ViewController中拆分出来，并整合起来在ViewController和Model中间加多一个ViewModel，ViewModel不直接引用View，ViewController也不引用Model中的方法，所有网络回调数据处理等逻辑都放到ViewModel中，ViewController通过ViewModel来请求数据和更新数据。</p>
<h2 id="如何实践MVVM"><a href="#如何实践MVVM" class="headerlink" title="如何实践MVVM"></a>如何实践MVVM</h2><h3 id="第一步-创建Model"><a href="#第一步-创建Model" class="headerlink" title="第一步:创建Model"></a>第一步:创建Model</h3><p>AFNetworking请求方法放到Model中<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Model</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *col;</div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *sort;</div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *tag3;</div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> startIndex;</div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> returnNumber;</div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> *imgs;</div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *tag;</div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> totalNum;</div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>)getImagesListWithPage: (<span class="built_in">NSInteger</span>)aPage SuccessBlock :(SuccessBlock)success FailBlock :(FailBlock)fail;</div></pre></td></tr></table></figure></p>
<p>具体实现，不多说：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Model</span></span></div><div class="line">+ (<span class="keyword">void</span>)getImagesListWithPage: (<span class="built_in">NSInteger</span>)aPage SuccessBlock :(SuccessBlock)success FailBlock :(FailBlock)fail &#123;</div><div class="line"></div><div class="line">    <span class="built_in">NSString</span> *urlString = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@%ld%@"</span>,</div><div class="line">    <span class="string">@"http://image.baidu.com/data/imgs?col=%e7%be%8e%e5%a5%b3&amp;tag=%e5%b0%8f%e6%b8%85%e6%96%b0&amp;sort=0&amp;pn=1"</span>,</div><div class="line">    aPage,<span class="string">@"&amp;rn=1&amp;p=channel&amp;from=1"</span>];</div><div class="line">    AFHTTPRequestOperationManager *managere = [AFHTTPRequestOperationManager manager];</div><div class="line">    [managere GET:urlString parameters:<span class="literal">nil</span> </div><div class="line">    success:^(AFHTTPRequestOperation * _Nonnull operation, <span class="keyword">id</span>  _Nonnull responseObject) &#123;</div><div class="line">        success(responseObject,<span class="literal">nil</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"success"</span>);</div><div class="line">    &#125; failure:^(AFHTTPRequestOperation * _Nullable operation, <span class="built_in">NSError</span> * _Nonnull error) &#123;</div><div class="line">        fail(<span class="literal">nil</span>,error);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"fail"</span>);</div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h3 id="第二步-创建ViewModel"><a href="#第二步-创建ViewModel" class="headerlink" title="第二步:创建ViewModel"></a>第二步:创建ViewModel</h3><ul>
<li>ViewModel的属性<ul>
<li>data : 请求获取的数据</li>
<li>racMsg : 请求成功和失败的信号量（主要用KVO对这个进行监视）<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewModel</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>,<span class="keyword">nonatomic</span>) <span class="built_in">NSDictionary</span> *data;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>,<span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *racMsg;  </div><div class="line"></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)getImagesList;</div><div class="line">- (<span class="keyword">void</span>)getNextImagesList;</div><div class="line">- (<span class="keyword">void</span>)getPreImagesList;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>ViewController中主要监视ViewModel的racMsg来发现data更新<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#define WS(weakSelf)  __weak __typeof(&amp;*self)weakSelf = self;</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewModel</span>()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">NSInteger</span> currentPage;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewModel</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">instancetype</span>)init &#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">self</span>.currentPage = <span class="number">0</span>;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)getImagesList &#123;</div><div class="line">    WS(ws)</div><div class="line">    [Model getImagesListWithPage:<span class="number">0</span> </div><div class="line">    SuccessBlock:^(<span class="built_in">NSDictionary</span> *responseObjectDict, <span class="built_in">NSError</span> *error) &#123;</div><div class="line">        ws.data = responseObjectDict;</div><div class="line">        ws.racMsg = <span class="string">@"success"</span>;</div><div class="line">    &#125; FailBlock:^(<span class="built_in">NSDictionary</span> *responseObjectDict, <span class="built_in">NSError</span> *error) &#123;</div><div class="line">        ws.data = <span class="literal">nil</span>;</div><div class="line">        ws.racMsg = <span class="string">@"fail"</span>;</div><div class="line"></div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)getNextImagesList &#123;</div><div class="line">    WS(ws)</div><div class="line">    <span class="keyword">self</span>.currentPage++;</div><div class="line">    [Model getImagesListWithPage:<span class="keyword">self</span>.currentPage </div><div class="line">    SuccessBlock:^(<span class="built_in">NSDictionary</span> *responseObjectDict, <span class="built_in">NSError</span> *error) &#123;</div><div class="line">        ws.data = responseObjectDict;</div><div class="line">        ws.racMsg = <span class="string">@"success"</span>;</div><div class="line">    &#125; FailBlock:^(<span class="built_in">NSDictionary</span> *responseObjectDict, <span class="built_in">NSError</span> *error) &#123;</div><div class="line">        ws.data = <span class="literal">nil</span>;</div><div class="line">        ws.racMsg = <span class="string">@"fail"</span>;</div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)getPreImagesList &#123;</div><div class="line">    WS(ws)</div><div class="line">    <span class="keyword">self</span>.currentPage = <span class="keyword">self</span>.currentPage == <span class="number">0</span> ? <span class="number">0</span> : <span class="keyword">self</span>.currentPage<span class="number">-1</span>;</div><div class="line">    [Model getImagesListWithPage:<span class="keyword">self</span>.currentPage </div><div class="line">    SuccessBlock:^(<span class="built_in">NSDictionary</span> *responseObjectDict, <span class="built_in">NSError</span> *error) &#123;</div><div class="line">        ws.data = responseObjectDict;</div><div class="line">        ws.racMsg = <span class="string">@"success"</span>;</div><div class="line">    &#125; FailBlock:^(<span class="built_in">NSDictionary</span> *responseObjectDict, <span class="built_in">NSError</span> *error) &#123;</div><div class="line">        ws.data = <span class="literal">nil</span>;</div><div class="line">        ws.racMsg = <span class="string">@"fail"</span>;</div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>可能会有人觉得为什么不直接监视data，但我个人更倾向于采用一种类似于信号量的机制，监听特定的信号来更新数据。如果直接监视data，则data只有nil和非nil两种情况，要进一步区分请求的状态的话必须要对data进行解析，增加了转换成本，不如直接采用多一个属性变量进行判断和协调</p>
<h2 id="第三步-ViewController中KVO设置"><a href="#第三步-ViewController中KVO设置" class="headerlink" title="第三步:ViewController中KVO设置"></a>第三步:ViewController中KVO设置</h2><p>ViewController直接持有viewModel<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>,<span class="keyword">nonatomic</span>) ViewModel *viewModel;</div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>,<span class="keyword">nonatomic</span>) <span class="built_in">UITextView</span> *showTextView;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>加载ViewController时初始化KVO和调用ViewModel方法getImagesList来请求数据<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="comment">// Do any additional setup after loading the view, typically from a nib.</span></div><div class="line"></div><div class="line">    <span class="comment">// requestData</span></div><div class="line">    [<span class="keyword">self</span> _initViews];</div><div class="line">    [<span class="keyword">self</span> setupKVO];</div><div class="line">    [<span class="keyword">self</span>.viewModel getImagesList];</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ViewController销毁时去除KVO<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)dealloc &#123;</div><div class="line">    [<span class="keyword">self</span> removeKVO];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>KVO相关的函数。observeValueForKeyPath只需对racMsg进行判断就可以知道data的值是否更新了，如果更新了就更新一下View。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">pragma mark - KVO</div><div class="line">- (<span class="keyword">void</span>)setupKVO &#123;</div><div class="line">    [<span class="keyword">self</span>.viewModel addObserver:<span class="keyword">self</span> </div><div class="line">    forKeyPath:<span class="string">@"racMsg"</span> options:(<span class="built_in">NSKeyValueObservingOptionNew</span>|<span class="built_in">NSKeyValueObservingOptionOld</span>) context:<span class="literal">nil</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)removeKVO &#123;</div><div class="line">    [<span class="keyword">self</span>.viewModel removeObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"racMsg"</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object </div><div class="line">         change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context &#123;</div><div class="line">    <span class="keyword">if</span> ([keyPath isEqualToString:<span class="string">@"racMsg"</span>]) &#123;</div><div class="line">        <span class="keyword">if</span> ([_viewModel.racMsg isEqualToString:<span class="string">@"success"</span>]) &#123;</div><div class="line">            _showTextView.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@"</span>,_viewModel.data];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            _showTextView.text = <span class="string">@"error"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>按钮点击事件和View的初始化<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#pragma mark - Event Response</span></div><div class="line">- (<span class="keyword">void</span>)getPre &#123;</div><div class="line">    [<span class="keyword">self</span>.viewModel getPreImagesList];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)getNext &#123;</div><div class="line">    [<span class="keyword">self</span>.viewModel getNextImagesList];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#pragma mark - Private</span></div><div class="line">- (<span class="keyword">void</span>)_initViews &#123;</div><div class="line">    <span class="built_in">UIButton</span> *preBtn = [[<span class="built_in">UIButton</span> alloc]initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">20</span>, <span class="number">50</span>, <span class="number">200</span>, <span class="number">40</span>)];</div><div class="line">    [preBtn setTitleColor:[<span class="built_in">UIColor</span> blueColor] forState:<span class="built_in">UIControlStateNormal</span>];</div><div class="line">    [preBtn setTitle:<span class="string">@"Pre"</span> forState:<span class="built_in">UIControlStateNormal</span>];</div><div class="line">    [preBtn addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(getPre) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</div><div class="line">    [<span class="keyword">self</span>.view addSubview:preBtn];</div><div class="line"></div><div class="line">    <span class="built_in">UIButton</span> *nextBtn = [[<span class="built_in">UIButton</span> alloc]initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">20</span>, <span class="number">150</span>, <span class="number">200</span>, <span class="number">40</span>)];</div><div class="line">    [nextBtn setTitleColor:[<span class="built_in">UIColor</span> redColor] forState:<span class="built_in">UIControlStateNormal</span>];</div><div class="line">    [nextBtn setTitle:<span class="string">@"nextBtn"</span> forState:<span class="built_in">UIControlStateNormal</span>];</div><div class="line">    [nextBtn addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(getNext) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</div><div class="line">    [<span class="keyword">self</span>.view addSubview:nextBtn];</div><div class="line"></div><div class="line">    _showTextView = [[<span class="built_in">UITextView</span> alloc]initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">200</span>, <span class="number">320</span>, <span class="number">200</span>)];</div><div class="line">    _showTextView.backgroundColor = [<span class="built_in">UIColor</span> lightGrayColor];</div><div class="line">    [<span class="keyword">self</span>.view addSubview:_showTextView];</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="实践MVVM的具体好处的例子"><a href="#实践MVVM的具体好处的例子" class="headerlink" title="实践MVVM的具体好处的例子"></a>实践MVVM的具体好处的例子</h2><h3 id="例子1"><a href="#例子1" class="headerlink" title="例子1"></a>例子1</h3><p>ViewController需要一个额外请求一个文章列表，这个文章列表的请求参数与当前请求图片列表的接口返回结果没有任何关联，可以并行请求。<br>在这种情况下，在ViewModel中加入方法getArticleList()和属性articleList以及articleMsg，然后在ViewController中需要调用该方法的位置调用该方法即可。KVO中的observeValueForKeyPath方法稍微修改一下<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"> (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object </div><div class="line">         change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context &#123;</div><div class="line">    <span class="keyword">if</span> ([keyPath isEqualToString:<span class="string">@"racMsg"</span>]) &#123;</div><div class="line">        <span class="keyword">if</span> ([_viewModel.racMsg isEqualToString:<span class="string">@"success"</span>]) &#123;</div><div class="line">            _showTextView.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@"</span>,_viewModel.data];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            _showTextView.text = <span class="string">@"error"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span>([keyPath isEqualToString:<span class="string">@"articleMsg"</span>]) &#123;</div><div class="line">        <span class="keyword">if</span> ([_viewModel.articleMsg isEqualToString:<span class="string">@"success"</span>]) &#123;</div><div class="line">            _articleTextView.text = _viewModel.articleList</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            _articleTextView.text = <span class="string">@"error"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可见并行业务功能上的扩展是非常简单的，整个Controller的总体逻辑几乎不用怎么变化，只需要改动局部细节即可</p>
<h3 id="例子2"><a href="#例子2" class="headerlink" title="例子2"></a>例子2</h3><p>同例子 1，但是文章列表的请求参数需要通过图片列表接口返回的结果获取，请求是串联嵌套的（即先请求图片列表接口，请求完成后，根据返回结果再请求文章列表接口）<br>对于嵌套的请求，如果采用传统MVC模式，就要在ViewController中加入两个block，一个嵌套另外一个，这样会让代码变得非常难看，而且会让子block依赖于父block，难以对其进行拆分。但如果采用MVVM，则会将所有的请求变化都置于KVO的监控之下，并作出统一的处理。<br>ViewModel中的与例子1一样，但ViewController中的处理稍微不同<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object </div><div class="line">         change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context &#123;</div><div class="line">    <span class="keyword">if</span> ([keyPath isEqualToString:<span class="string">@"racMsg"</span>]) &#123;</div><div class="line">        <span class="keyword">if</span> ([_viewModel.racMsg isEqualToString:<span class="string">@"success"</span>]) &#123;</div><div class="line">            _showTextView.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@"</span>,_viewModel.data];</div><div class="line">            <span class="comment">// 请求文章</span></div><div class="line">            [_viewModel getArticleList];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            _showTextView.text = <span class="string">@"error"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span>([keyPath isEqualToString:<span class="string">@"articleMsg"</span>]) &#123;</div><div class="line">        <span class="keyword">if</span> ([_viewModel.articleMsg isEqualToString:<span class="string">@"success"</span>]) &#123;</div><div class="line">            _articleTextView.text = _viewModel.articleList</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            _articleTextView.text = <span class="string">@"error"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出还是不需要改动大逻辑，即可对有依赖的业务进行扩展。</p>
<h2 id="例子3"><a href="#例子3" class="headerlink" title="例子3"></a>例子3</h2><p><code>ViewController中有很多数据转换逻辑，多个ViewController的数据转换逻辑都相同的情况。</code><br>ViewModel中不仅只包含请求逻辑，还可以包含数据转换的逻辑，还有一些不知要怎么归类的杂七杂八的逻辑。多个ViewController发生相同的数据转换的情况是经常会有的，如果把数据转换逻辑写到Controller之中，会让每一个Controller都持有一个转换逻辑，这对于数据转换逻辑的统一来说是非常糟糕的。如果把相同的数据转换逻辑都抽象封装到同一个ViewModel中，ViewController不直接持有数据转换逻辑，而是通过ViewModel来调用的话，每个ViewController只需要维护一个ViewModel实例即可，所有转换细节都可以在ViewModel中进行统一修改。Controller只关心数据和数据与View的交互，不应该关心数据之间的转换和数据怎样获取的，这应该是MVVM的一个原则。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>MVVM的核心在于绑定，本文采用的是KVO的绑定机制，能够很好与Objective-C和Cocoa结合起来，不需要借用第三方的类库进行数据绑定。<br>除了使用KVO，业界通常采用的是ReactiveCocoa。但是，ReactiveCocoa的学习成本过高，不适合轻量级的开发，而MVVM只是一种开发模式，并不是一种具体的框架，所以如果不是非常想深入使用MVVM的精髓的话，是没有必要去学习ReactiveCocoa的。网上还有一些讨论MVVM的博客提到ViewModel直接对View进行操作，其实这是一种很不严谨的做法，MVVM中的ViewModel不应该关心View的显示，只应该关心数据的获取和转换，View如何显示那是ViewController的职责。所以凡是在ViewModel中引用了UIKit的，个人认为都不是一种严格意义上的MVVM。<ul>
<li>当然MVVM也有其自身的不足，比如引入ViewModel之后，文件数量增加了不少，总的代码量其实也会增加，这对于极简主义者来说并不是一种很好的模式。而且MVVM的开发思路与MVC是不同的，开发者要转换思路采用MVVM的开发方式其实还是有不少的学习成本，而且对于大部分简单业务来说，使用MVVM会增加业务的复杂度，显得臃肿和多余。本文中使用KVO的MVVM模式，从本质上来说其实是MVC的衍生，把C中的一部分拆分出来并隔离M和C，所以从模式上来说，这样是完全可以兼容传统的MVC开发模式的。因此，对于简单的业务，可以直接采用MVC的模式开发，不需要额外创建一个ViewModel。对于复杂业务，就采用KVO的MVVM模式，进行业务拆分和复用。这种折中的方法能够将MVC和MVVM的优点都利用起来，避免只使用一个造成开发效率上的降低。<br>MVVM不应该被误解和神化，使用MVVM只是提供多了一个不错的选择，要不要使用它，还是要看具体的项目而定。但是用上了，就停不下来了。</li>
</ul>
</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://www.teehanlax.com/blog/model-view-viewmodel-for-ios/" target="_blank" rel="external">Model-View-ViewModel for iOS</a></li>
<li><a href="https://objccn.io/issue-13-1/" target="_blank" rel="external">MVVM介绍</a></li>
</ul>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/10/16/文一/" class="archive-article-date">
  	<time datetime="2016-10-16T03:51:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-10-16</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/KVO/">KVO</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
    <a href="/2016/10/19/ios证书与签名机制/" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          ios证书与签名机制
        
      </div>
    </a>
  
  
</nav>




<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
	    <a class="jiathis_button_twitter"></a>
	    <a class="jiathis_button_plus"></a> 
	    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="//v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>









      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 燕 航
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js"></script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
      <li data-hook="tools-section-friends"><span class="text">友链</span><i class="icon-link"></i></li>
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<a href="/tags/KVO/" style="font-size: 10px;">KVO</a> <a href="/tags/签名/" style="font-size: 10px;">签名</a>
    			</div>
    	</section>
    

    
    	<section class="tools-section tools-section-friends">
  		
  			<div class="friends-wrap" id="js-friends">
  			
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.csdn.net/xiangriikui/article/details/52207153">CSDN</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接2</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接3</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接4</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接5</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接6</a>
  	        
  	        </div>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">记录学习点滴&lt;br&gt;iOS码农一枚&lt;br&gt;喜欢专研&lt;br&gt;</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>